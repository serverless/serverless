/**
 * @typedef {import('@axiomhq/js').Axiom} Axiom
 * @property {Object} datasets - The datasets object.
 * @property {function(): Promise<Dataset[]>} datasets.list - Lists all datasets.
 * @property {function(Object): Promise<Dataset>} datasets.create - Creates a new dataset.
 */

/**
 * @typedef {Object} Dataset
 * @property {string} name - The name of the dataset.
 */

import { ServerlessError, ServerlessErrorCodes } from '@serverless/util'

/**
 * Finds a dataset by name.
 *
 * @param {Object} params - The parameters.
 * @param {string} params.datasetName - The name of the dataset to find.
 * @param {Dataset[]} params.datasets - The list of datasets to search.
 * @returns {Dataset|undefined} - The found dataset or undefined if not found.
 */
export const findDataset = ({ datasetName, datasets }) => {
  return datasets.find((dataset) => dataset.name === datasetName)
}

/**
 * @typedef {Object} FindOrCreateDatasetResult
 * @property {Dataset} dataset - The found or created dataset.
 * @property {boolean} created - Indicates if the dataset was created.
 */

/**
 * Finds or creates a dataset.
 *
 * @param {Object} params - The parameters.
 * @param {Axiom} params.client - The Axiom client.
 * @param {Dataset[]} params.datasets - The list of datasets to search.
 * @param {string} params.datasetName - The name of the dataset to find or create.
 * @returns {Promise<FindOrCreateDatasetResult>} - The found or created dataset and creation status.
 */
const findOrCreateDataset = async ({ client, datasets, datasetName }) => {
  let dataset = findDataset({ datasetName, datasets })
  let created = false

  if (!dataset) {
    try {
      dataset = await client.datasets.create(
        {
          name: datasetName,
        },
        { referrer: 'serverless' },
      )
      created = true
    } catch (error) {
      if (error.message?.includes('Bad Request')) {
        throw new ServerlessError(
          `Failed to create dataset ${datasetName}. Check number of datasets limit or dataset name. Original Axiom error: ${error.message}`,
          ServerlessErrorCodes.axiom.AXIOM_CREATE_DATASET_FAILED,
        )
      }
      throw error
    }
  }
  return { dataset, created }
}
/**
 * Generates a dataset name with the given prefix.
 *
 * @param {string} prefix - The prefix for the dataset name.
 * @returns {string} - The generated dataset name.
 */
export const getGeneratedDatasetName = (prefix) => {
  return `${prefix}-aws-cloudwatch`
}

/**
 * Finds or creates an autogenerated dataset.
 *
 * @param {Object} params - The parameters.
 * @param {Axiom} params.client - The Axiom client.
 * @param {string} params.prefix - The prefix for the dataset name.
 * @param {string} [params.datasetName] - The name of the dataset to find or create.
 * @returns {Promise<FindOrCreateDatasetResult>} - The found or created dataset and creation status.
 */
export const findOrCreateAutogeneratedDataset = async ({
  client,
  prefix,
  datasetName,
}) => {
  const datasets = await client.datasets.list()
  if (datasetName) {
    return await findOrCreateDataset({ client, datasets, datasetName })
  }
  const generatedDatasetName = getGeneratedDatasetName(prefix)
  return await findOrCreateDataset({
    client,
    datasets,
    datasetName: generatedDatasetName,
  })
}
