# Full-Stack Agent Example
# Comprehensive example showing all AgentCore resource types working together

service: full-stack-agent

provider:
  name: aws
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  # Gateway configuration (auto-created when tools are defined)
  agents:
    gateway:
      authorizerType: AWS_IAM
      protocolConfiguration:
        mcp:
          supportedVersions:
            - '2024-11-05'
          instructions: 'Use these tools for external integrations'
          searchType: SEMANTIC

custom:
  agentCore:
    # Default tags applied to all resources
    defaultTags:
      Project: FullStackAgent
      Environment: ${self:provider.stage}

# Lambda functions used as tools
functions:
  weather:
    name: ${self:service}-${self:provider.stage}-weather
    handler: handlers/weather.handler
    runtime: python3.12
    timeout: 30
    memorySize: 256

agents:
  # Shared memory configuration
  memory:
    agentMemory:
      description: Stores conversation history and enables semantic search
      expiration: 90
      strategies:
        - SemanticMemoryStrategy:
            Name: ConversationSearch
            Namespaces:
              - /conversations/{sessionId}
        - UserPreferenceMemoryStrategy:
            Name: UserPreferences
            Namespaces:
              - /users/{userId}/preferences

  # Shared tools (Gateway is auto-created)
  tools:
    weather-tool:
      function: weather
      description: Get current weather for a location
      toolSchema:
        - name: getWeather
          description: Get current weather for a location
          inputSchema:
            type: object
            properties:
              location:
                type: string
                description: City name or location
            required:
              - location

  # Runtime - The main agent runtime
  mainAgent:
    type: runtime
    description: Full-stack AI agent with browser and code execution capabilities
    artifact:
      docker:
        path: .
        file: Dockerfile
        repository: full-stack-agent
    protocol: HTTP
    network:
      networkMode: PUBLIC
    # Pass allowed headers to the runtime
    requestHeaders:
      allowlist:
        - X-Amzn-Bedrock-AgentCore-Runtime-Custom-User-Id
        - X-Amzn-Bedrock-AgentCore-Runtime-Custom-Session-Id
        - X-Amzn-Bedrock-AgentCore-Runtime-Custom-Correlation-Id
    # Optional: Configure session lifecycle
    lifecycle:
      idleRuntimeSessionTimeout: 900 # 15 minutes
      maxLifetime: 3600 # 1 hour
    # Reference shared memory and tools
    memory: agentMemory
    tools:
      weather: weather-tool

  # Browser - For web scraping and browsing
  webBrowser:
    type: browser
    description: Enables web browsing capabilities for the agent
    network:
      networkMode: PUBLIC
    signing:
      enabled: false

  # Code Interpreter - For code execution
  codeExecutor:
    type: codeInterpreter
    description: Sandboxed Python code execution environment
    network:
      networkMode: SANDBOX

  # Workload Identity - For OAuth2 authentication to external services
  agentIdentity:
    type: workloadIdentity
    oauth2ReturnUrls:
      - https://${self:service}.example.com/auth/callback
      - http://localhost:3000/auth/callback

resources:
  Outputs:
    AgentRuntimeArn:
      Description: ARN of the deployed agent runtime
      Value:
        Fn::GetAtt:
          - MainAgentRuntime
          - AgentRuntimeArn

    AgentMemoryId:
      Description: ID of the agent memory
      Value:
        Fn::GetAtt:
          - AgentMemoryMemory
          - MemoryId

    GatewayUrl:
      Description: URL of the auto-created MCP gateway
      Value:
        Fn::GetAtt:
          - AgentCoreGateway
          - GatewayUrl
